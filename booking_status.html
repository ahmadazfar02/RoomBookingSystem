<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking Status - UTM Room Booking</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root{ 
        --utm-maroon: #800000;
        --utm-maroon-light: #a31313;
        --utm-maroon-dark: #600000;
        --accent: #800000;
        --accent-dark: #600000;
        --bg-light: #f8fafc;
        --card-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
        --pending: #f59e0b;
        --approved: #16a34a;
        --rejected: #dc2626;
        --cancelled: #64748b;
    }
    
    * { 
        box-sizing: border-box; 
        margin: 0; 
        padding: 0; 
    }
    
    body { 
        font-family: 'Inter', sans-serif;
        background: var(--bg-light);
        min-height: 100vh;
        color: var(--text-primary);
    }
    
    /* Header */
    .main-header {
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    
    .header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }
    
    .logo-section {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .logo { 
        height: 60px; 
    }
    
    .logo-text {
        display: flex;
        flex-direction: column;
    }
    
    .logo-text h1 {
        font-size: 18px;
        font-weight: 700;
        color: var(--utm-maroon);
        margin: 0;
    }
    
    .logo-text p {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-family: 'Inter', sans-serif;
    }
    
    .btn-secondary {
        background: var(--utm-maroon);
        color: white;
        box-shadow: 0 2px 4px rgba(128, 0, 0, 0.2);
    }
    
    .btn-secondary:hover {
        background: var(--utm-maroon-light);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(128, 0, 0, 0.3);
    }
    
    /* Main Container */
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    
    /* Page Title Card */
    .page-title-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }
    
    .page-title-card h1 {
        font-size: 28px;
        font-weight: 700;
        color: var(--utm-maroon);
        margin-bottom: 8px;
    }
    
    .page-title-card p {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    /* Filters Card */
    .filters-card {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }
    
    .filters {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }
    
    .filter-btn:hover {
        border-color: var(--utm-maroon);
        color: var(--utm-maroon);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .filter-btn.active {
        background: var(--utm-maroon);
        color: white;
        border-color: var(--utm-maroon);
        box-shadow: 0 2px 4px rgba(128, 0, 0, 0.2);
    }
    
    .status-count {
        margin-left: auto;
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        padding: 8px 16px;
        background: var(--bg-light);
        border-radius: 8px;
    }
    
    /* Table Card */
    .table-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
        overflow: hidden;
    }
    
    .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 14px;
    }
    
    th, td {
        padding: 16px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }
    
    thead th {
        background: var(--utm-maroon);
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 13px;
    }
    
    tbody tr {
        background: white;
        transition: all 0.2s ease;
    }
    
    tbody tr:hover {
        background: #fafafa;
    }
    
    tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* Status Badges */
    .status-pending {
        color: #92400e;
        background: #fef3c7;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
        border: 1px solid #fde68a;
    }
    
    .status-booked {
        color: #065f46;
        background: #d1fae5;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
        border: 1px solid #a7f3d0;
    }
    
    .status-cancelled {
        color: #374151;
        background: #e5e7eb;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
        border: 1px solid #d1d5db;
    }
    
    .status-rejected {
        color: #7f1d1d;
        background: #fee2e2;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 13px;
        display: inline-block;
        border: 1px solid #fecaca;
    }
    
    /* Slot Pills */
    .slot-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 120px;
        overflow-y: auto;
    }
    
    .slot-pill {
        background: var(--bg-light);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
        border: 1px solid var(--border);
        transition: all 0.2s ease;
    }
    
    .slot-pill:hover {
        background: #e0e7ff;
        border-color: var(--utm-maroon);
    }
    
    /* Action Buttons */
    .btn-cancel {
        padding: 8px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        margin-right: 8px;
        margin-bottom: 6px;
        font-family: 'Inter', sans-serif;
    }
    
    .btn-edit {
        padding: 8px 14px;
        background: #f97316;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(249, 115, 22, 0.2);
        font-family: 'Inter', sans-serif;
    }
    
    .btn-edit:hover { 
        background: #ea580c;
        transform: translateY(-1px); 
        box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3); 
    }
    
    .btn-cancel:hover:not(:disabled) { 
        background: #b91c1c;
        transform: translateY(-1px); 
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3); 
    }
    
    .btn-cancel:disabled, 
    .btn-edit:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
    }
    
    /* Loading & error */
    .loading-cell { 
        text-align: center; 
        padding: 40px !important; 
        color: var(--text-secondary); 
        font-size: 15px; 
    }
    
    .error-cell { 
        text-align: left; 
        padding: 20px !important; 
        color: #dc2626; 
        background: #fef2f2; 
        border-radius: 8px; 
    }
    
    .small { 
        font-size: 12px; 
        color: var(--text-secondary); 
        font-weight: 400; 
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .header-content { 
            flex-wrap: wrap;
        }
        
        .filters { 
            justify-content: center; 
        }
        
        .status-count { 
            margin-left: 0; 
            width: 100%; 
            text-align: center; 
        }
        
        table, thead, tbody, th, td, tr { 
            display: block; 
        }
        
        thead { 
            display: none; 
        }
        
        tbody tr { 
            margin-bottom: 16px; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 16px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
        }
        
        td { 
            border: 0; 
            padding: 8px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        td::before { 
            content: attr(data-label); 
            font-weight: 600; 
            color: var(--text-secondary); 
            margin-right: 12px; 
        }
    }
  </style>
</head>
<style>
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
</style>
<body>
  <header class="main-header">
    <div class="header-content">
      <div class="logo-section">
        <img src="assets/images/utmlogo.png" alt="UTM Logo" class="logo">
        <div class="logo-text">
          <h1>Room Booking System</h1>
          <p>Universiti Teknologi Malaysia</p>
        </div>
      </div>
      
      <a href="timetable.html" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left"></i>
        Back to Timetable
      </a>
    </div>
  </header>

  <div class="container">
    <div class="page-title-card">
      <h1><i class="fa-solid fa-calendar-check"></i> Booking Status</h1>
      <p>View and manage your room bookings</p>
    </div>

    <div class="filters-card">
      <div class="filters" aria-label="Booking filters">
        <button class="filter-btn active" data-filter="pending">
          <i class="fa-solid fa-clock"></i>
          Booking Requests
        </button>
        <button class="filter-btn" data-filter="booked">
          <i class="fa-solid fa-check-circle"></i>
          My Bookings
        </button>
        <button class="filter-btn" data-filter="cancelled">
          <i class="fa-solid fa-ban"></i>
          Cancelled
        </button>
        <button class="filter-btn" data-filter="rejected">
          <i class="fa-solid fa-times-circle"></i>
          Rejected
        </button>
        <button class="filter-btn" data-filter="all">
          <i class="fa-solid fa-list"></i>
          All
        </button>
        <div class="status-count" id="statusCount">Loading…</div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-wrapper">
        <table id="sessionsTable" aria-label="Booking sessions">
          <thead>
            <tr>
              <th style="width:140px">Session ID</th>
              <th style="width:150px">Room</th>
              <th style="width:150px">Dates</th>
              <th style="min-width:200px">Time Slots</th>
              <th style="width:120px">Status</th>
              <th style="width:140px">Action</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="loading-cell"><i class="fa-solid fa-spinner fa-spin"></i> Loading sessions...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  
// Toast notification function
function showToast(message, type = 'info', duration = 3000) { // Default 3 seconds
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        `;
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
    const colors = {
        success: { bg: '#10b981', border: '#059669' },
        error: { bg: '#ef4444', border: '#dc2626' },
        warning: { bg: '#f59e0b', border: '#d97706' },
        info: { bg: '#3b82f6', border: '#2563eb' }
    };
    const color = colors[type] || colors.info;
    
    // Note: .firstElementChild is used below to safely ignore whitespace text nodes
    toast.innerHTML = `
        <div style="background: ${color.bg}; color: white; padding: 16px 20px; border-radius: 8px;
            border-left: 4px solid ${color.border}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideIn 0.3s ease-out;">
            <span style="font-size: 20px; font-weight: bold; flex-shrink: 0;">${icons[type]}</span>
            <span style="flex: 1; font-size: 14px; line-height: 1.5;">${message}</span>
            <button onclick="this.closest('div').parentElement.remove()" style="background: transparent;
                border: none; color: white; font-size: 20px; cursor: pointer; opacity: 0.7; 
                padding: 0; width: 24px; height: 24px; flex-shrink: 0;">×</button>
        </div>
    `;
    container.appendChild(toast);
    
    if (duration > 0) {
        setTimeout(() => {
            // FIX: Use firstElementChild to target the DIV, not the text node
            if (toast.firstElementChild) {
                toast.firstElementChild.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 280); // Wait for animation to finish
            } else {
                toast.remove();
            }
        }, duration);
    }
}

// Confirmation modal
function showConfirm(title, message) {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 10000; animation: fadeIn 0.2s;`;
        
        overlay.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.3s;">
                <h3 style="margin: 0 0 12px 0; font-size: 20px; color: #1f2937; font-weight: 600;">${title}</h3>
                <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 14px; line-height: 1.5;">${message}</p>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancel-modal-btn" style="background: #f3f4f6; color: #374151; border: none; 
                        padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
                        font-family: 'Inter', sans-serif;">No, Keep It</button>
                    <button id="confirm-modal-btn" style="background: #ef4444; color: white; border: none; 
                        padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
                        font-family: 'Inter', sans-serif;">Yes, Cancel</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        overlay.querySelector('#confirm-modal-btn').onclick = () => {
            overlay.remove();
            resolve(true);
        };
        overlay.querySelector('#cancel-modal-btn').onclick = () => {
            overlay.remove();
            resolve(false);
        };
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
                resolve(false);
            }
        };
    });
}

// Confirmation modal for EDIT action
function showEditConfirm(title, message) {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 10000; animation: fadeIn 0.2s;`;
        
        overlay.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.3s;">
                <h3 style="margin: 0 0 12px 0; font-size: 20px; color: #1f2937; font-weight: 600;">${title}</h3>
                <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 14px; line-height: 1.5;">${message}</p>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancel-edit-btn" style="background: #f3f4f6; color: #374151; border: none; 
                        padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
                        font-family: 'Inter', sans-serif;">No, Go Back</button>
                    <button id="confirm-edit-btn" style="background: #f97316; color: white; border: none; 
                        padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
                        font-family: 'Inter', sans-serif;">Yes, Edit Booking</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        overlay.querySelector('#confirm-edit-btn').onclick = () => {
            overlay.remove();
            resolve(true);
        };
        overlay.querySelector('#cancel-edit-btn').onclick = () => {
            overlay.remove();
            resolve(false);
        };
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
                resolve(false);
            }
        };
    });
}

function escapeHtml(s){ 
  if(s===0) return '0'; 
  if(!s) return ''; 
  return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
}

const tbody = document.querySelector('#sessionsTable tbody');
const statusCountEl = document.getElementById('statusCount');
const filterButtons = document.querySelectorAll('.filter-btn');

let currentFilter = 'pending';

// Filter button handlers
filterButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    filterButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    fetchSessions(currentFilter);
  });
});

function fetchSessions(filter='pending'){
  tbody.innerHTML = '<tr><td colspan="7" class="loading-cell"><i class="fa-solid fa-spinner fa-spin"></i> Loading sessions...</td></tr>';
  statusCountEl.textContent = 'Loading…';
  
  const url = 'booking_status.php?view=status' + (filter && filter!=='all' ? '&filter=' + encodeURIComponent(filter) : '');
  
  fetch(url, {cache:'no-store'})
    .then(r => {
      if (!r.ok) throw new Error('Network response not ok');
      return r.json();
    })
    .then(json => {
      let sessions = [];
      if (Array.isArray(json)) sessions = json;
      else if (json && Array.isArray(json.sessions)) sessions = json.sessions;
      else if (json && json.success && Array.isArray(json.sessions)) sessions = json.sessions;
      else sessions = [];

      if (!sessions || sessions.length === 0) {
        const filterName = getFilterDisplayName(filter);
        tbody.innerHTML = `<tr><td colspan="7" class="loading-cell"><i class="fa-solid fa-inbox"></i> No ${filterName.toLowerCase()} found.</td></tr>`;
        statusCountEl.textContent = '0 sessions';
        return;
      }
      renderSessions(sessions);
      const filterName = getFilterDisplayName(filter);
      statusCountEl.textContent = `${sessions.length} ${filterName.toLowerCase()}`;
    })
    .catch(err => {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="7" class="error-cell"><i class="fa-solid fa-exclamation-triangle"></i> <strong>Error loading sessions:</strong><br>${escapeHtml(err.message)}</td></tr>`;
      statusCountEl.textContent = 'Error';
    });
}

function getFilterDisplayName(filter) {
  const names = {
    'pending': 'Booking Requests',
    'booked': 'Approved Bookings',
    'cancelled': 'Cancelled Sessions',
    'rejected': 'Rejected Requests',
    'all': 'Sessions'
  };
  return names[filter] || 'Sessions';
}

function renderSessions(sessions){
  if (!sessions || sessions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="loading-cell"><i class="fa-solid fa-inbox"></i> No sessions found.</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  sessions.forEach(s => {
    const tr = document.createElement('tr');

    // Session ID
    const sid = escapeHtml(String(s.session_id || s.id || s.active_key || s.session || ''));
    const sidLabel = sid.length > 24 ? sid.slice(0,12) + '...' : sid;

    // Room
    const room = escapeHtml(s.room_name || s.room || s.room_id || '');

    // Dates
    let datesDisplay = '';
    if (Array.isArray(s.dates) && s.dates.length > 0) {
      if (s.dates.length === 1) {
        datesDisplay = escapeHtml(s.dates[0]);
      } else {
        const sorted = s.dates.slice().sort();
        datesDisplay = `${escapeHtml(sorted[0])} → ${escapeHtml(sorted[sorted.length-1])}<br><span class="small">(${s.dates.length} days)</span>`;
      }
    } else if (s.slot_date) {
      datesDisplay = escapeHtml(s.slot_date);
    }

    // Slots
    let slotsHtml = '';
    if (Array.isArray(s.slots) && s.slots.length > 0) {
      const pills = s.slots.map(slot => 
        `<span class="slot-pill"><i class="fa-solid fa-clock"></i> ${escapeHtml(slot.date)} • ${escapeHtml(slot.time)}</span>`
      );
      slotsHtml = `<div class="slot-list">${pills.join('')}</div>`;
    } else if (s.time_start && s.time_end && s.slot_date) {
      slotsHtml = `<div class="slot-list"><span class="slot-pill"><i class="fa-solid fa-clock"></i> ${escapeHtml(s.slot_date)} • ${escapeHtml((s.time_start||'').slice(0,5))} - ${escapeHtml((s.time_end||'').slice(0,5))}</span></div>`;
    }

    // Status badge
    const st = (s.status || '').toLowerCase();
    let statusClass = 'status-cancelled', statusLabel = s.status || '';
    if (st === 'pending') { 
      statusClass = 'status-pending'; 
      statusLabel = 'Pending'; 
    } else if (st === 'booked') { 
      statusClass = 'status-booked'; 
      statusLabel = 'Approved'; 
    } else if (st === 'cancelled') { 
      statusClass = 'status-cancelled'; 
      statusLabel = 'Cancelled'; 
    } else if (st === 'rejected') {
      statusClass = 'status-rejected';
      statusLabel = 'Rejected';
    }

    // Button logic
    const statusLower = (s.status || '').toLowerCase();
    const isOwner = (s.is_owner === 1 || s.is_owner === '1' || s.is_owner === true);
    const isAdmin = (s.is_admin === 1 || s.is_admin === '1' || s.is_admin === true);

    let showEdit = false;
    let showCancel = false;
    let isPastBooking = false;

    // Check if booking is in the past
    if (Array.isArray(s.slots) && s.slots.length > 0) {
      const now = new Date();
      const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
      const currentTime = now.getHours() * 60 + now.getMinutes(); // minutes since midnight

      // Get the last slot (latest date/time)
      const lastSlot = s.slots[s.slots.length - 1];
      const slotDate = lastSlot.date;
      const slotTime = lastSlot.time ? lastSlot.time.split('-')[1] : ''; // Get end time
      
      if (slotDate < today) {
        // Date is in the past
        isPastBooking = true;
      } else if (slotDate === today && slotTime) {
        // Same day, check time
        const [hours, minutes] = slotTime.split(':').map(Number);
        const slotMinutes = hours * 60 + minutes;
        if (slotMinutes < currentTime) {
          isPastBooking = true;
        }
      }
    }

    if (isOwner || isAdmin) {
      if (statusLower === 'pending') {
        showEdit = true;
        showCancel = true;
      } else if (statusLower === 'booked') {
        showEdit = false;
        // Only allow cancel if not past booking
        showCancel = !isPastBooking;
      } else if (statusLower === 'rejected') {
        showEdit = false;
        showCancel = true;
      } else if (statusLower === 'cancelled') {
        showEdit = false;
        showCancel = false;
      }
    }


    // Build action buttons
    let actionParts = [];
    if (showCancel) {
      if (isPastBooking && statusLower === 'booked') {
        // Show disabled button with message for past bookings
        actionParts.push(`<button class="btn-cancel" disabled title="Cannot cancel past bookings"><i class="fa-solid fa-times"></i> Past Event</button>`);
      } else {
        actionParts.push(`<button class="btn-cancel" data-session="${escapeHtml(String(s.session_id || s.id || ''))}" data-id="${escapeHtml(String(s.id || s.session_id || ''))}"><i class="fa-solid fa-times"></i> Cancel</button>`);
      }
    }
    if (showEdit) {
      actionParts.push(`<button class="btn-edit" data-session="${escapeHtml(String(s.session_id || s.id || ''))}" data-room="${escapeHtml(String(s.room_id || s.room || ''))}"><i class="fa-solid fa-edit"></i> Edit</button>`);
    }
    const actionHtml = actionParts.length ? actionParts.join('') : '<span class="small">—</span>';

    // Comments
    let comment = '';
    if (s.slot_count) comment = `${s.slot_count} slot${s.slot_count !== 1 ? 's' : ''}`;
    if (!comment && (s.purpose || s.description)) comment = (s.purpose || s.description);

    tr.innerHTML = `
      <td data-label="Session ID">
        <strong>${sidLabel}</strong><br>
        <span class="small"><i class="fa-solid fa-calendar"></i> ${escapeHtml(s.created_at || '')}</span>
      </td>
      <td data-label="Room"><i class="fa-solid fa-door-open"></i> ${room}</td>
      <td data-label="Dates">${datesDisplay}</td>
      <td data-label="Time Slots">${slotsHtml}</td>
      <td data-label="Status"><span class="${statusClass}">${escapeHtml(statusLabel)}</span></td>
      <td data-label="Action">${actionHtml}</td>
      <td data-label="Comments" class="small">${escapeHtml(comment)}</td>
    `;

    tbody.appendChild(tr);
  });

  // Wire cancel buttons
  tbody.querySelectorAll('.btn-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
      handleCancelButton(btn);
    });
  });

  // Wire edit buttons
  tbody.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', async () => {
      const sessionId = btn.dataset.session || btn.dataset.id;
      const room = btn.dataset.room || '';
      if (!sessionId) {
        alert('Missing session id for edit.');
        return;
      }

      const confirmed = await showEditConfirm(
        'Edit Booking Session',
        'Are you sure you want to edit this booking? This will free your current slots so you can pick new ones.'
      );

      if (!confirmed) return;

      try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Preparing...';

        const resp = await postJson({ action: 'start_edit', session_id: sessionId });

        if (!resp || !resp.success) {
          alert('Could not start edit: ' + (resp && resp.msg ? resp.msg : 'Unknown error'));
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-edit"></i> Edit';
          return;
        }

        const payload = {
          session_id: sessionId,
          room_id: resp.room_id || resp.room || room || '',
          slots: resp.slots || [],
          created_at: resp.created_at || ''
        };
        localStorage.setItem('edit_booking_payload', JSON.stringify(payload));

        const params = new URLSearchParams();
        params.set('edit_session', sessionId);
        if (payload.room_id) params.set('room', payload.room_id);
        window.location.href = 'timetable.html?' + params.toString();

      } catch (err) {
        console.error('Edit start error', err);
        alert('Failed to start edit: ' + (err.message || err));
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-edit"></i> Edit';
      }
    });
  });
}

function postJson(payload){
  return fetch('booking_status.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload),
    cache:'no-store'
  }).then(r => {
    if (!r.ok) throw new Error('Network response not ok');
    return r.json();
  });
}

async function handleCancelButton(btn) {

  const sessionId = btn.dataset.session || btn.dataset.id;

  if (!sessionId) {
    showToast('Missing session ID', 'error');
    return;
  }

  // FIX: Use showConfirm (Cancel style) instead of showEditConfirm
  const confirmed = await showConfirm(
    'Cancel Booking Session',
    'Are you sure you want to cancel this booking? This action cannot be undone.'
  );
  
  if (!confirmed) return;

  btn.disabled = true;
  const originalHtml = btn.innerHTML;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cancelling...';

  try {
    const resp = await postJson({ 
      action: 'cancel_session', 
      session_id: sessionId, 
      reason: 'Cancelled by user' 
    });

    if (resp && resp.success) {
      const count = resp.cancelled_count || 1;
      showToast(
        resp.msg || `Successfully cancelled ${count} booking(s)`, 
        'success'
      );
      setTimeout(() => fetchSessions(currentFilter), 1500);
    } else {
      showToast(resp.msg || 'Failed to cancel booking', 'error');
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    }
  } catch (err) {
    console.error('Cancel error:', err);
    showToast('Network error. Please try again.', 'error');
    btn.disabled = false;
    btn.innerHTML = originalHtml;
  }
}

// Initial load
document.addEventListener('DOMContentLoaded', () => {
  fetchSessions('pending');
});
</script>
</body>
</html>